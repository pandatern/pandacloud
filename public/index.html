<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panda Cloud</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        black: '#000000',
                        white: '#ffffff',
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="/performance.js"></script>
    <style>
        body { background-color: #ffffff; color: #000000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .container-bg { background: #ffffff; border: 1px solid #e5e5e5; }
        .header-bg { background: #ffffff; border-bottom: 1px solid #e5e5e5; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #000000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        tbody tr:hover { background-color: #f9f9f9; }
        .btn-primary { background-color: #000000; color: #ffffff; }
        .btn-primary:hover { background-color: #333333; }
        .btn-secondary { background-color: #f5f5f5; color: #000000; border: 1px solid #e5e5e5; }
        .btn-secondary:hover { background-color: #e5e5e5; }
        .btn-danger { background-color: #ffffff; color: #dc2626; border: 1px solid #dc2626; }
        .btn-danger:hover { background-color: #dc2626; color: #ffffff; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-white">
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-white">
        <div class="container-bg w-full max-w-sm p-8 rounded-lg shadow-lg">
            <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-black rounded-lg flex items-center justify-center shadow-sm">
                    <i class="ph-fill ph-cloud text-2xl text-white"></i>
                </div>
            </div>
            <h2 class="text-2xl font-semibold text-center mb-2 text-black">Panda Cloud</h2>
            <p class="text-gray-600 text-center text-sm mb-8">Secure File Management</p>
            <form onsubmit="event.preventDefault(); login();" class="space-y-4">
                <input type="text" id="userId" placeholder="User ID" autocomplete="username" class="w-full bg-white text-black placeholder-gray-400 px-4 py-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent" required>
                <input type="password" id="password" placeholder="Password" autocomplete="current-password" class="w-full bg-white text-black placeholder-gray-400 px-4 py-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent" required>
                <button type="submit" id="loginBtn" class="w-full btn-primary font-medium py-3 rounded transition flex justify-center items-center gap-2 mt-2">Sign In</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden flex-1 flex flex-col h-full bg-white">
        <header class="h-14 header-bg flex items-center justify-between px-6 flex-shrink-0">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-black text-white rounded flex items-center justify-center text-lg">
                    <i class="ph-fill ph-cloud"></i>
                </div>
                <div class="flex flex-col">
                    <h1 id="userGreeting" class="font-medium text-sm leading-tight text-black">Files</h1>
                    <span id="status" class="text-xs text-gray-500">Panda Cloud</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="refresh()" class="w-8 h-8 rounded btn-secondary flex items-center justify-center transition">
                    <i class="ph-bold ph-arrows-clockwise text-sm"></i>
                </button>
                <button onclick="logout()" class="w-8 h-8 rounded btn-danger flex items-center justify-center transition">
                    <i class="ph-bold ph-sign-out text-sm"></i>
                </button>
            </div>
        </header>
        
        <main class="flex-1 overflow-y-auto p-6">
            <!-- Folder Navigation Bar -->
            <div id="folderNavigation" class="w-full mx-auto container-bg rounded-lg mb-4 p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="ph-bold ph-folder text-lg text-black"></i>
                        <span id="currentPath" class="text-sm text-black font-medium">/</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="goToParentFolder()" id="parentFolderBtn" class="btn-secondary px-3 py-1 rounded text-xs hidden">
                            <i class="ph-bold ph-arrow-up text-sm"></i>
                            Up
                        </button>
                        <button onclick="showCreateFolderDialog()" class="btn-primary px-3 py-1 rounded text-xs">
                            <i class="ph-bold ph-folder-plus text-sm"></i>
                            New Folder
                        </button>
                    </div>
                </div>
            </div>

            <div class="w-full mx-auto container-bg rounded-lg flex flex-col overflow-hidden">
                <div class="flex-grow overflow-x-auto">
                    <table id="file-table" class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="w-12 px-4 py-3 font-medium text-gray-500 text-xs uppercase tracking-wider text-center">Type</th>
                                <th class="px-4 py-3 font-medium text-gray-500 text-xs uppercase tracking-wider">Name</th>
                                <th class="w-24 px-4 py-3 font-medium text-gray-500 text-xs uppercase tracking-wider text-right whitespace-nowrap hidden sm:table-cell">Size</th>
                                <th class="w-32 px-4 py-3 font-medium text-gray-500 text-xs uppercase tracking-wider text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list-body" class="divide-y divide-gray-100">
                            <!-- Folders and files will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="list-placeholder" class="flex-grow flex justify-center py-12"></div>
                <footer id="table-footer" class="flex-shrink-0 border-t border-gray-200 px-4 py-2 text-xs text-gray-500">
                    <!-- Footer content will be inserted here -->
                </footer>
            </div>
        </main>

        <!-- Upload UI -->
        <div id="uploadStatus" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-white border border-gray-300 text-black px-6 py-3 rounded-full shadow-lg z-50 hidden flex items-center gap-3">
            <div class="spinner w-4 h-4 border-2"></div>
            <span class="text-sm">Uploading...</span>
        </div>
        <label class="fixed bottom-6 right-6 z-40 group cursor-pointer">
            <div class="w-12 h-12 btn-primary rounded-full flex items-center justify-center shadow-lg transition transform group-hover:scale-105 group-active:scale-95">
                <i class="ph-bold ph-plus text-lg text-white group-hover:rotate-90 transition duration-300"></i>
            </div>
            <input type="file" multiple class="hidden" onchange="handleUpload(this)">
        </label>
    </div>

    <!-- Create Folder Modal -->
    <div id="createFolderModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 hidden flex items-center justify-center p-6">
        <div class="container-bg w-full max-w-md p-6 rounded-lg shadow-lg">
            <h3 class="text-lg font-semibold text-black mb-4">Create New Folder</h3>
            <input type="text" id="folderNameInput" placeholder="Folder name" class="w-full bg-white text-black placeholder-gray-400 px-4 py-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent mb-4">
            <div class="flex gap-3">
                <button onclick="createFolder()" class="flex-1 btn-primary font-medium py-3 rounded transition">Create</button>
                <button onclick="closeCreateFolderDialog()" class="flex-1 btn-secondary font-medium py-3 rounded transition">Cancel</button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="iframe-viewer" class="fixed inset-0 z-50 bg-white hidden flex-col">
        <!-- Header bar -->
        <div class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-20 bg-white border-b border-gray-200">
            <span id="viewer-title" class="text-sm text-black font-medium truncate max-w-md"></span>
            <div class="flex items-center gap-2">
                <button id="viewer-download-btn" class="w-8 h-8 flex items-center justify-center btn-secondary rounded text-black hover:bg-gray-200" style="display: none;">
                    <i class="ph-bold ph-download text-sm"></i>
                </button>
                <button onclick="closeIframeViewer()" class="w-8 h-8 flex items-center justify-center btn-secondary rounded text-black hover:bg-gray-200">
                    <i class="ph-bold ph-x text-sm"></i>
                </button>
            </div>
        </div>
        
        <!-- Spinner -->
        <div id="viewer-spinner" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10">
            <div class="spinner !w-8 !h-8"></div>
        </div>
        
        <!-- Iframe container with proper spacing -->
        <div class="flex-1 pt-16 pb-4 px-4">
            <iframe id="viewer-iframe" class="w-full h-full border border-gray-200 rounded bg-white"></iframe>
        </div>
    </div>

    <script>
        // Enhanced session management with localStorage persistence
        let sessionId = localStorage.getItem('panda_session_id') || null;
        let currentPrefix = localStorage.getItem('panda_current_prefix') || "";
        let isAdmin = localStorage.getItem('panda_is_admin') === 'true' || false;
        let currentUser = localStorage.getItem('panda_current_user') || "";

        // Save session data to localStorage
        function saveSession(sessionData) {
            sessionId = sessionData.sessionId;
            isAdmin = sessionData.isAdmin || false;
            currentUser = sessionData.username || '';
            
            localStorage.setItem('panda_session_id', sessionId);
            localStorage.setItem('panda_is_admin', isAdmin.toString());
            localStorage.setItem('panda_current_user', currentUser);
            
            console.log('üíæ Session saved to localStorage');
        }

        // Clear session data from localStorage  
        function clearSession() {
            sessionId = null;
            currentPrefix = "";
            isAdmin = false;
            currentUser = "";
            
            localStorage.removeItem('panda_session_id');
            localStorage.removeItem('panda_is_admin'); 
            localStorage.removeItem('panda_current_user');
            localStorage.removeItem('panda_current_prefix');
            
            console.log('üóëÔ∏è Session cleared from localStorage');
        }

        // Test if stored session is still valid
        async function validateStoredSession() {
            if (!sessionId) return false;
            
            try {
                console.log('üîç Testing stored session validity...');
                const response = await fetch('/api/files', { 
                    headers: { 'X-Session-ID': sessionId } 
                });
                
                if (response.ok) {
                    console.log('‚úÖ Stored session is valid');
                    return true;
                } else {
                    console.log('‚ùå Stored session is invalid');
                    clearSession();
                    return false;
                }
            } catch (error) {
                console.log('‚ùå Session validation failed:', error.message);
                clearSession();
                return false;
            }
        }

        // Universal API error handler for session issues
        async function handleApiResponse(response, result) {
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    // Unauthorized - likely session issue
                    showToast('Session expired. Please log in again.', 'error');
                    clearSession();
                    setTimeout(() => location.reload(), 2000);
                    return false;
                }
            }
            
            if (result && !result.success) {
                if (result.error && result.error.toLowerCase().includes('session')) {
                    // Session-related error
                    showToast('Session expired. Please log in again.', 'error');
                    clearSession();
                    setTimeout(() => location.reload(), 2000);
                    return false;
                }
            }
            
            return true;
        }

        // Enhanced API call wrapper
        async function apiCall(url, options = {}) {
            try {
                if (!sessionId) {
                    throw new Error('No active session');
                }
                
                // Ensure session header is always included
                options.headers = options.headers || {};
                options.headers['X-Session-ID'] = sessionId;
                
                const response = await fetch(url, options);
                const result = await response.json();
                
                if (await handleApiResponse(response, result)) {
                    return { response, result };
                } else {
                    throw new Error('Session invalid');
                }
            } catch (error) {
                if (error.message.includes('session') || error.message.includes('Session')) {
                    clearSession();
                    setTimeout(() => location.reload(), 1000);
                }
                throw error;
            }
        }

        // Auto-restore session on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üîÑ Checking for existing session...');
            
            if (sessionId && await validateStoredSession()) {
                // Session is valid, show main app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                // Update UI with user info
                if (currentUser) {
                    document.getElementById('userGreeting').textContent = `Welcome, ${currentUser}`;
                }
                
                // Load files
                refresh();
                console.log('üéâ Session restored successfully');
            } else {
                // No valid session, show login screen
                console.log('üîê No valid session found, showing login');
            }
        });

        // Login function - must be global for form onsubmit
        async function login() {
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('password').value;
            if (!userId || !password) { 
                showToast('User ID and Password are required.', 'error'); 
                return; 
            }

            const loginBtn = document.getElementById('loginBtn');
            const originalLoginBtnHtml = loginBtn.innerHTML;
            loginBtn.innerHTML = '<div class="spinner"></div>';
            
            try {
                const response = await fetch('/api/login', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ userId: userId, password: password }) 
                });
                const result = await response.json();
                if (result.success) { 
                    // Save session data to localStorage
                    saveSession(result);
                    currentPrefix = ""; // Reset to root
                    
                    document.getElementById('loginScreen').classList.add('hidden'); 
                    document.getElementById('app').classList.remove('hidden');
                    
                    // Show admin indicator if user is admin
                    const adminIndicator = isAdmin ? " (Admin)" : "";
                    document.getElementById('userGreeting').innerText = `Files: ${currentUser}${adminIndicator}`;
                    
                    document.getElementById('viewer-iframe').addEventListener('load', () => {
                        document.getElementById('viewer-spinner').style.display = 'none';
                        document.getElementById('viewer-iframe').style.opacity = '1';
                    });
                    updateCurrentPath();
                    refresh();
                    
                    showToast(`Welcome back, ${currentUser}!`, 'success');
                } else { 
                    showToast('Login Failed: ' + result.error, 'error'); 
                }
            } catch (error) { 
                showToast('Connection Error: ' + error.message, 'error');
            } finally { 
                loginBtn.innerHTML = originalLoginBtnHtml;
            }
        }

        function logout() { 
            clearSession(); 
            showToast('Logged out successfully', 'info');
            location.reload(); 
        }

        // --- Helper Functions ---
        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded text-white shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'error' ? 'bg-red-600' : 
                type === 'success' ? 'bg-green-600' : 'bg-gray-700'
            }`;
            toast.innerText = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(full)';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        function getIconForFile(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'ph-file-pdf', 'zip': 'ph-file-archive', 'rar': 'ph-file-archive', '7z': 'ph-file-archive',
                'mp3': 'ph-file-audio', 'wav': 'ph-file-audio', 'ogg': 'ph-file-audio',
                'mp4': 'ph-file-video', 'webm': 'ph-file-video', 'mov': 'ph-file-video',
                'txt': 'ph-file-text', 'md': 'ph-file-text', 'doc': 'ph-file-doc', 'docx': 'ph-file-doc',
                'jpg': 'ph-image', 'jpeg': 'ph-image', 'png': 'ph-image', 'gif': 'ph-image', 'webp': 'ph-image'
            };
            return iconMap[extension] || 'ph-file';
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes == 0) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // --- Viewer Functions ---
        function openFile(presignedUrl, downloadUrl, filename) {
            // Always try to preview first, with download as backup
            openIframeViewer(presignedUrl, filename, downloadUrl);
        }

        function openIframeViewer(url, title, downloadUrl) {
            const viewer = document.getElementById('iframe-viewer');
            const iframe = document.getElementById('viewer-iframe');
            const spinner = document.getElementById('viewer-spinner');
            
            document.getElementById('viewer-title').innerText = title;
            
            // Add download button to viewer header
            const downloadBtn = document.getElementById('viewer-download-btn');
            downloadBtn.onclick = () => downloadFile(downloadUrl, title);
            downloadBtn.style.display = 'block';
            
            spinner.style.display = 'block';
            iframe.style.opacity = '0';
            
            iframe.src = url;
            iframe.onload = () => {
                spinner.style.display = 'none';
                iframe.style.opacity = '1';
            };
            iframe.onerror = () => {
                spinner.style.display = 'none';
                showToast('Unable to preview. Downloading file...', 'info');
                closeIframeViewer();
                downloadFile(downloadUrl, title);
            };
            
            viewer.classList.remove('hidden');
            viewer.classList.add('flex');
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast(`Downloading ${filename}...`, 'success');
        }

        function closeIframeViewer() {
            const viewer = document.getElementById('iframe-viewer');
            const iframe = document.getElementById('viewer-iframe');
            const downloadBtn = document.getElementById('viewer-download-btn');
            
            viewer.classList.add('hidden');
            viewer.classList.remove('flex');
            iframe.src = 'about:blank';
            downloadBtn.style.display = 'none';
        }

        // --- Folder Navigation Functions ---
        function updateCurrentPath() {
            const pathElement = document.getElementById('currentPath');
            const parentBtn = document.getElementById('parentFolderBtn');
            
            if (currentPrefix === "") {
                pathElement.innerText = "/";
                parentBtn.classList.add('hidden');
            } else {
                pathElement.innerText = "/" + currentPrefix;
                parentBtn.classList.remove('hidden');
            }
        }

        function navigateToFolder(prefix) {
            currentPrefix = prefix;
            localStorage.setItem('panda_current_prefix', currentPrefix);
            updateCurrentPath();
            refresh();
        }

        function goToParentFolder() {
            if (currentPrefix !== "") {
                const parts = currentPrefix.split('/').filter(p => p.length > 0);
                if (parts.length > 1) {
                    currentPrefix = parts.slice(0, -1).join('/') + '/';
                } else {
                    currentPrefix = "";
                }
                localStorage.setItem('panda_current_prefix', currentPrefix);
                updateCurrentPath();
                refresh();
            }
        }

        function showCreateFolderDialog() {
            document.getElementById('createFolderModal').classList.remove('hidden');
            document.getElementById('folderNameInput').focus();
        }

        function closeCreateFolderDialog() {
            document.getElementById('createFolderModal').classList.add('hidden');
            document.getElementById('folderNameInput').value = '';
        }

        async function createFolder() {
            const folderName = document.getElementById('folderNameInput').value.trim();
            if (!folderName) {
                showToast('Please enter a folder name', 'error');
                return;
            }

            try {
                const { result } = await apiCall('/api/create-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        folderName: folderName,
                        currentPrefix: currentPrefix
                    })
                });

                if (result.success) {
                    showToast('Folder created successfully', 'success');
                    closeCreateFolderDialog();
                    refresh(true);
                } else {
                    showToast('Failed to create folder: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error creating folder: ' + error.message, 'error');
            }
        }

        // Close modal when clicking outside
        document.getElementById('createFolderModal').addEventListener('click', (e) => {
            if (e.target.id === 'createFolderModal') {
                closeCreateFolderDialog();
            }
        });

        // Handle Enter key in folder name input
        document.getElementById('folderNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createFolder();
            }
        });

        // --- Core App Functions ---
        async function refresh(force = false) {
            const tbody = document.getElementById('file-list-body');
            const placeholder = document.getElementById('list-placeholder');
            const footer = document.getElementById('table-footer');
            tbody.innerHTML = '';
            footer.innerHTML = '';
            placeholder.innerHTML = '<div class="spinner border-gray-600 border-t-white"></div>';
            
            try {
                let url = currentPrefix ? `/api/files?prefix=${encodeURIComponent(currentPrefix)}` : '/api/files';
                if (force) {
                    url += (url.includes('?') ? '&' : '?') + 'force=true';
                }
                const { result } = await apiCall(url);
                placeholder.innerHTML = '';
                
                if (result.success) {
                    let totalItems = 0;
                    
                    // Add folders first
                    if (result.folders && result.folders.length > 0) {
                        result.folders.forEach(folder => {
                            const row = tbody.insertRow();
                            row.className = 'hover:bg-gray-50 transition-colors duration-150 group';
                            
                            const escapedFolderName = escapeHtml(folder.name);
                            row.innerHTML = `
                                <td class="px-4 py-3 text-center align-middle text-lg"><i class="ph-fill ph-folder text-yellow-500 group-hover:text-yellow-600 transition-colors"></i></td>
                                <td class="px-4 py-3 align-middle font-medium text-gray-900 truncate max-w-xs sm:max-w-md lg:max-w-xl" title="${escapedFolderName}">
                                    <span class="cursor-pointer hover:underline" onclick="navigateToFolder('${folder.prefix}')">${escapedFolderName}</span>
                                </td>
                                <td class="px-4 py-3 align-middle text-right text-gray-500 text-xs hidden sm:table-cell">--</td>
                                <td class="px-4 py-3 align-middle text-center whitespace-nowrap">
                                    <button class="open-folder-btn btn-secondary px-3 py-1.5 rounded text-xs font-medium hover:bg-gray-200 transition-colors shadow-sm">Open</button>
                                </td>
                            `;
                            
                            row.querySelector('.open-folder-btn').addEventListener('click', () => navigateToFolder(folder.prefix));
                            row.addEventListener('dblclick', () => navigateToFolder(folder.prefix));
                            totalItems++;
                        });
                    }
                    
                    // Add files
                    if (result.files && result.files.length > 0) {
                        result.files.forEach(file => {
                            const row = tbody.insertRow();
                            row.className = 'hover:bg-gray-50 transition-colors duration-150 group';
                            
                            const iconClass = getIconForFile(file.key);
                            const fileName = file.key.split('/').pop(); // Get just the filename
                            const escapedFileName = escapeHtml(fileName);
                            const escapedFileKey = escapeHtml(file.key);
                            
                            row.innerHTML = `
                                <td class="px-4 py-3 text-center align-middle text-lg"><i class="ph ${iconClass} text-gray-400 group-hover:text-gray-600 transition-colors"></i></td>
                                <td class="px-4 py-3 align-middle text-gray-700 truncate max-w-xs sm:max-w-md lg:max-w-xl" title="${escapedFileKey}">${escapedFileName}</td>
                                <td class="px-4 py-3 align-middle text-right text-gray-500 text-xs font-mono hidden sm:table-cell">${formatBytes(file.size)}</td>
                                <td class="px-4 py-3 align-middle text-center whitespace-nowrap space-x-1">
                                    <button class="open-btn btn-secondary px-3 py-1.5 rounded text-xs font-medium hover:bg-gray-200 transition-colors shadow-sm">Open</button>
                                    <button class="delete-btn btn-danger px-3 py-1.5 rounded text-xs font-medium hover:bg-red-50 hover:text-red-700 transition-colors shadow-sm">Delete</button>
                                </td>
                            `;

                            // Single "Open" button - always try preview first
                            row.querySelector('.open-btn').addEventListener('click', () => openFile(file.presignedUrl, file.downloadUrl, fileName));
                            
                            const deleteBtn = row.querySelector('.delete-btn');
                            if (deleteBtn) {
                                deleteBtn.addEventListener('click', async (e) => {
                                    e.stopPropagation();
                                    if (confirm(`Delete "${fileName}" permanently?`)) {
                                        row.style.opacity = '0.5';
                                        deleteBtn.disabled = true;
                                        deleteBtn.innerText = 'Deleting...';

                                        try {
                                            const { result } = await apiCall('/api/delete', { 
                                                method: 'POST', 
                                                headers: { 
                                                    'Content-Type': 'application/json'
                                                }, 
                                                body: JSON.stringify({ key: file.key }) 
                                            });

                                            if (result.success) {
                                                row.remove();
                                                showToast(`Deleted ${fileName}`, 'success');
                                            } else {
                                                showToast("Delete failed: " + (result.error || "Unknown server error"), 'error');
                                                row.style.opacity = '1';
                                                deleteBtn.disabled = false;
                                                deleteBtn.innerText = 'Delete';
                                            }
                                        } catch (err) {
                                            showToast("Error during deletion: " + err.message, 'error');
                                            row.style.opacity = '1';
                                            deleteBtn.disabled = false;
                                            deleteBtn.innerText = 'Delete';
                                        }
                                    }
                                });
                            }
                            totalItems++;
                        });
                    }
                    
                    footer.innerText = `${totalItems} items`;
                    if (totalItems === 0) {
                        placeholder.innerHTML = `<div class="text-center text-gray-400 mt-10">This folder is empty</div>`;
                        footer.innerText = '0 items';
                    }
                } else if (result.error) {
                    // Show error with option to debug
                    placeholder.innerHTML = `
                        <div class="text-center text-red-600 mt-10">
                            <p>Error: ${escapeHtml(result.error)}</p>
                            <button onclick="debugS3()" class="mt-4 btn-secondary px-4 py-2 rounded text-sm">
                                Debug S3 Connection
                            </button>
                        </div>`;
                } else {
                    placeholder.innerHTML = `<div class="text-center text-gray-400 mt-10">No files</div>`;
                    footer.innerText = '0 items';
                }
            } catch (e) { 
                placeholder.innerHTML = `<div class="text-center text-red-600 mt-10">Connection error</div>`; 
            }
        }

        async function handleUpload(input) {
            const files = Array.from(input.files); if(files.length === 0) return;
            const status = document.getElementById('uploadStatus');
            const statusText = status.querySelector('span');
            status.classList.remove('hidden');
            
            for (const file of files) {
                try {
                    statusText.innerText = `Signing ${file.name}...`;
                    
                    // Build full key with current folder prefix
                    const fileKey = currentPrefix + file.name;
                    
                    const { result: signData } = await apiCall('/api/sign-upload', { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ key: fileKey }) 
                    });
                    if(!signData.success) throw new Error("Could not sign upload: " + signData.error);

                    await new Promise((resolve, reject) => {
                        const xhr = new XMLHttpRequest();
                        xhr.open('PUT', signData.url, true);
                        xhr.upload.onprogress = (event) => {
                            if (event.lengthComputable) {
                                const percentComplete = Math.round((event.loaded / event.total) * 100);
                                statusText.innerText = `Uploading ${file.name}: ${percentComplete}%`;
                            }
                        };
                        xhr.onload = () => {
                            if (xhr.status >= 200 && xhr.status < 300) { resolve(xhr.response); } 
                            else { reject(new Error(`S3 upload failed: ${xhr.status} ${xhr.statusText}`)); }
                        };
                        xhr.onerror = () => reject(new Error("Network error during upload."));
                        xhr.send(file);
                    });
                } catch (error) { 
                    showToast(`Upload error for ${file.name}: ${error.message}`, 'error'); 
                }
            }
            status.classList.add('hidden'); 
            input.value = ''; 
            refresh(true);
        }

        // Debug function for S3 issues
        async function debugS3() {
            try {
                const { result } = await apiCall('/api/debug/s3');
                
                if (result.success) {
                    console.log('S3 Debug Results:', result.diagnostics);
                    
                    let message = 'S3 Debug Results:\\n\\n';
                    
                    // Show cache state first
                    if (result.diagnostics.cache_state) {
                        const cache = result.diagnostics.cache_state;
                        if (cache.status === 'no_cache') {
                            message += 'Cache State: Not cached yet\\n';
                        } else {
                            message += `Cache State: ACTIVE\\n`;
                            message += `  Root Listing: ${cache.root_tier}\\n`;
                            message += `  Folder Listing: ${cache.folder_tier}\\n`;
                        }
                        message += '\\n';
                    }
                    
                    // Show test results
                    for (const [test, result] of Object.entries(result.diagnostics)) {
                        if (test === 'cache_state') continue; // Already shown above
                        
                        if (result.error) {
                            message += `${test}: ERROR - ${result.error}\\n`;
                        } else {
                            message += `${test}: ${result.status} - ${result.message}\\n`;
                        }
                    }
                    
                    alert(message);
                } else {
                    showToast('Debug failed: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Debug error: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>