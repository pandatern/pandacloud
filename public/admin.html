<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panda Cloud - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body { background-color: #ffffff; color: #000000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .container-bg { background: #ffffff; border: 1px solid #e5e5e5; }
        .header-bg { background: #ffffff; border-bottom: 1px solid #e5e5e5; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #000000; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        tbody tr:hover { background-color: #f9f9f9; }
        .btn-primary { background-color: #000000; color: #ffffff; }
        .btn-primary:hover { background-color: #333333; }
        .btn-secondary { background-color: #f5f5f5; color: #000000; border: 1px solid #e5e5e5; }
        .btn-secondary:hover { background-color: #e5e5e5; }
        .btn-danger { background-color: #ffffff; color: #dc2626; border: 1px solid #dc2626; }
        .btn-danger:hover { background-color: #dc2626; color: #ffffff; }
        .btn-success { background-color: #ffffff; color: #16a34a; border: 1px solid #16a34a; }
        .btn-success:hover { background-color: #16a34a; color: #ffffff; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden bg-white">
    <!-- Admin Login Screen -->
    <div id="adminLoginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-white">
        <div class="container-bg w-full max-w-sm p-8 rounded-lg shadow-lg">
            <div class="flex justify-center mb-6">
                <div class="w-16 h-16 bg-black rounded-lg flex items-center justify-center shadow-sm">
                    <i class="ph-fill ph-gear text-2xl text-white"></i>
                </div>
            </div>
            <h2 class="text-2xl font-semibold text-center mb-2 text-black">Admin Panel</h2>
            <p class="text-gray-600 text-center text-sm mb-8">User Management System</p>
            <form onsubmit="event.preventDefault(); adminLogin();" class="space-y-4">
                <input type="text" id="adminUserId" placeholder="Admin User ID" class="w-full bg-white text-black placeholder-gray-400 px-4 py-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent" required>
                <input type="password" id="adminPassword" placeholder="Admin Password" class="w-full bg-white text-black placeholder-gray-400 px-4 py-3 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent" required>
                <button type="submit" id="adminLoginBtn" class="w-full btn-primary font-medium py-3 rounded transition flex justify-center items-center gap-2 mt-2">
                    <i class="ph-bold ph-sign-in"></i>
                    Admin Sign In
                </button>
            </form>
            <div class="mt-6 pt-6 border-t border-gray-200">
                <a href="/" class="text-xs text-gray-500 hover:text-gray-700 flex items-center justify-center gap-2">
                    <i class="ph-bold ph-arrow-left"></i>
                    Back to Main App
                </a>
            </div>
        </div>
    </div>

    <!-- Admin App -->
    <div id="adminApp" class="hidden flex-1 flex flex-col h-full bg-white">
        <!-- Header -->
        <header class="h-16 header-bg flex items-center justify-between px-6 flex-shrink-0">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-black text-white rounded flex items-center justify-center text-xl">
                    <i class="ph-fill ph-gear"></i>
                </div>
                <div class="flex flex-col">
                    <h1 class="font-semibold text-lg leading-tight text-black">Admin Panel</h1>
                    <span id="adminStatus" class="text-sm text-gray-500">User Management</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <a href="/" class="btn-secondary px-4 py-2 rounded text-sm flex items-center gap-2 transition">
                    <i class="ph-bold ph-house text-sm"></i>
                    Main App
                </a>
                <button onclick="refreshUsers()" class="btn-secondary px-4 py-2 rounded text-sm flex items-center gap-2 transition">
                    <i class="ph-bold ph-arrows-clockwise text-sm"></i>
                    Refresh
                </button>
                <button onclick="adminLogout()" class="btn-danger px-4 py-2 rounded text-sm flex items-center gap-2 transition">
                    <i class="ph-bold ph-sign-out text-sm"></i>
                    Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto p-6">
            <div class="max-w-7xl mx-auto space-y-6">
                <!-- Statistics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="container-bg p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Users</p>
                                <p id="totalUsers" class="text-2xl font-bold text-black">0</p>
                            </div>
                            <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center">
                                <i class="ph-fill ph-users text-xl text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div class="container-bg p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Active Sessions</p>
                                <p id="activeSessions" class="text-2xl font-bold text-black">-</p>
                            </div>
                            <div class="w-12 h-12 bg-black rounded-lg flex items-center justify-center">
                                <i class="ph-fill ph-pulse text-xl text-white"></i>
                            </div>
                        </div>
                    </div>
                    <div class="container-bg p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">System Status</p>
                                <p class="text-2xl font-bold text-green-600">Online</p>
                            </div>
                            <div class="w-12 h-12 bg-green-600 rounded-lg flex items-center justify-center">
                                <i class="ph-fill ph-check-circle text-xl text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Add New User -->
                    <div class="container-bg p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-black mb-4 flex items-center gap-2">
                            <i class="ph-bold ph-user-plus"></i>
                            Add New User
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="newUsername" placeholder="Enter username" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="newPassword" placeholder="Enter password" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Access Key</label>
                                <input type="text" id="newAccessKey" placeholder="S3 Access Key" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Secret Key</label>
                                <input type="password" id="newSecretKey" placeholder="S3 Secret Key" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bucket Name</label>
                                <input type="text" id="newBucket" placeholder="S3 Bucket Name" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Endpoint</label>
                                    <input type="text" id="newEndpoint" value="s3.tebi.io" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                                    <input type="text" id="newRegion" value="us-east-1" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                                </div>
                            </div>
                            <button onclick="addUser()" class="w-full btn-success font-medium py-3 rounded transition flex justify-center items-center gap-2">
                                <i class="ph-bold ph-plus"></i>
                                Add User
                            </button>
                        </div>
                    </div>

                    <!-- Update User -->
                    <div class="container-bg p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-black mb-4 flex items-center gap-2">
                            <i class="ph-bold ph-pencil-simple"></i>
                            Update User
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Select User</label>
                                <select id="updateUserSelect" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                                    <option value="">Choose user to update...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">New Password (optional)</label>
                                <input type="password" id="updatePassword" placeholder="Leave blank to keep current" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">New Access Key (optional)</label>
                                <input type="text" id="updateAccessKey" placeholder="Leave blank to keep current" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">New Secret Key (optional)</label>
                                <input type="password" id="updateSecretKey" placeholder="Leave blank to keep current" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">New Bucket Name (optional)</label>
                                <input type="text" id="updateBucket" placeholder="Leave blank to keep current" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">New Endpoint (optional)</label>
                                    <input type="text" id="updateEndpoint" placeholder="Leave blank to keep current" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">New Region (optional)</label>
                                    <input type="text" id="updateRegion" placeholder="Leave blank to keep current" class="w-full bg-white border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-black">
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="updateUser()" class="flex-1 btn-primary font-medium py-3 rounded transition flex justify-center items-center gap-2">
                                    <i class="ph-bold ph-floppy-disk"></i>
                                    Update User
                                </button>
                                <button onclick="deleteUser()" class="flex-1 btn-danger font-medium py-3 rounded transition flex justify-center items-center gap-2">
                                    <i class="ph-bold ph-trash"></i>
                                    Delete User
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="container-bg rounded-lg">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-black flex items-center gap-2">
                            <i class="ph-bold ph-list"></i>
                            All Users
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="border-b border-gray-200 bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bucket</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Endpoint</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Region</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-gray-200">
                                <!-- Users will be inserted here by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    <div id="usersTablePlaceholder" class="p-12 text-center">
                        <div class="spinner mx-auto border-gray-600 border-t-black"></div>
                        <p class="text-gray-500 mt-4">Loading users...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let adminSessionId = null;

        // --- Helper Functions ---
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg text-white shadow-lg transform transition-all duration-300 translate-x-full ${
                type === 'error' ? 'bg-red-600' : 
                type === 'success' ? 'bg-green-600' : 'bg-gray-700'
            }`;
            toast.innerHTML = `<div class="flex items-center gap-2">
                <i class="ph-bold ${type === 'error' ? 'ph-x-circle' : type === 'success' ? 'ph-check-circle' : 'ph-info'}"></i>
                <span>${message}</span>
            </div>`;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        // --- Admin Authentication ---
        async function adminLogin() {
            const userId = document.getElementById('adminUserId').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!userId || !password) { 
                showToast('User ID and Password are required.', 'error'); 
                return; 
            }

            const loginBtn = document.getElementById('adminLoginBtn');
            const originalBtnHtml = loginBtn.innerHTML;
            loginBtn.innerHTML = '<div class="spinner !w-5 !h-5"></div>';
            
            try {
                const response = await fetch('/api/login', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ userId: userId, password: password }) 
                });
                const result = await response.json();
                
                if (result.success) { 
                    if (!result.isAdmin) {
                        showToast('Access denied: Admin privileges required', 'error');
                        return;
                    }
                    
                    adminSessionId = result.sessionId; 
                    document.getElementById('adminLoginScreen').classList.add('hidden'); 
                    document.getElementById('adminApp').classList.remove('hidden');
                    document.getElementById('adminStatus').innerText = `Logged in as: ${result.username} (Admin)`;
                    loadDashboard();
                } else { 
                    showToast('Login Failed: ' + result.error, 'error'); 
                }
            } catch (error) { 
                showToast('Connection Error: ' + error.message, 'error');
            } finally { 
                loginBtn.innerHTML = originalBtnHtml;
            }
        }

        function adminLogout() { 
            adminSessionId = null; 
            location.reload(); 
        }

        // --- Dashboard Functions ---
        async function loadDashboard() {
            await refreshUsers();
        }

        async function refreshUsers() {
            const tbody = document.getElementById('usersTableBody');
            const placeholder = document.getElementById('usersTablePlaceholder');
            const totalUsersEl = document.getElementById('totalUsers');
            
            tbody.innerHTML = '';
            placeholder.style.display = 'block';
            
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'X-Session-ID': adminSessionId }
                });
                const result = await response.json();
                
                if (result.success) {
                    placeholder.style.display = 'none';
                    totalUsersEl.textContent = result.users.length;
                    
                    // Populate users table
                    result.users.forEach(user => {
                        const row = tbody.insertRow();
                        row.className = 'hover:bg-gray-50';
                        
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-black rounded-full flex items-center justify-center mr-3">
                                        <i class="ph-bold ph-user text-white text-sm"></i>
                                    </div>
                                    <span class="text-sm font-medium text-black">${user.username}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.bucket}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.endpoint}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${user.region}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                <button onclick="selectUserForUpdate('${user.username}')" class="btn-secondary px-3 py-1 rounded text-xs mr-2">Edit</button>
                                <button onclick="quickDeleteUser('${user.username}')" class="btn-danger px-3 py-1 rounded text-xs">Delete</button>
                            </td>
                        `;
                    });
                    
                    // Populate update dropdown
                    const select = document.getElementById('updateUserSelect');
                    select.innerHTML = '<option value="">Choose user to update...</option>';
                    result.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                    
                    if (result.users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-500">No users found</td></tr>';
                    }
                } else {
                    placeholder.innerHTML = `<p class="text-red-600">Error: ${result.error}</p>`;
                }
            } catch (error) {
                placeholder.innerHTML = `<p class="text-red-600">Connection error: ${error.message}</p>`;
            }
        }

        function selectUserForUpdate(username) {
            document.getElementById('updateUserSelect').value = username;
            // Scroll to update section
            document.querySelector('h3[class*="Update User"]').scrollIntoView({ behavior: 'smooth' });
        }

        // --- User Management Functions ---
        async function addUser() {
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const accessKey = document.getElementById('newAccessKey').value;
            const secretKey = document.getElementById('newSecretKey').value;
            const bucket = document.getElementById('newBucket').value;
            const endpoint = document.getElementById('newEndpoint').value;
            const region = document.getElementById('newRegion').value;

            if (!username || !password || !accessKey || !secretKey || !bucket) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/add-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': adminSessionId
                    },
                    body: JSON.stringify({
                        username, password, accessKey, secretKey, bucket, endpoint, region
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('User added successfully', 'success');
                    clearAddUserForm();
                    refreshUsers();
                } else {
                    showToast('Failed to add user: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error adding user: ' + error.message, 'error');
            }
        }

        async function updateUser() {
            const username = document.getElementById('updateUserSelect').value;
            if (!username) {
                showToast('Please select a user to update', 'error');
                return;
            }

            const updates = {};
            const fields = ['password', 'accessKey', 'secretKey', 'bucket', 'endpoint', 'region'];
            
            fields.forEach(field => {
                const value = document.getElementById('update' + field.charAt(0).toUpperCase() + field.slice(1)).value;
                if (value) updates[field] = value;
            });

            if (Object.keys(updates).length === 0) {
                showToast('Please enter at least one field to update', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/update-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': adminSessionId
                    },
                    body: JSON.stringify({ username, updates })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('User updated successfully', 'success');
                    clearUpdateUserForm();
                    refreshUsers();
                } else {
                    showToast('Failed to update user: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error updating user: ' + error.message, 'error');
            }
        }

        async function deleteUser() {
            const username = document.getElementById('updateUserSelect').value;
            if (!username) {
                showToast('Please select a user to delete', 'error');
                return;
            }

            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }

            await performDeleteUser(username);
        }

        async function quickDeleteUser(username) {
            if (!confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                return;
            }

            await performDeleteUser(username);
        }

        async function performDeleteUser(username) {
            try {
                const response = await fetch('/api/admin/delete-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': adminSessionId
                    },
                    body: JSON.stringify({ username })
                });

                const result = await response.json();
                if (result.success) {
                    showToast('User deleted successfully', 'success');
                    clearUpdateUserForm();
                    refreshUsers();
                } else {
                    showToast('Failed to delete user: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error deleting user: ' + error.message, 'error');
            }
        }

        function clearAddUserForm() {
            document.getElementById('newUsername').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newAccessKey').value = '';
            document.getElementById('newSecretKey').value = '';
            document.getElementById('newBucket').value = '';
            document.getElementById('newEndpoint').value = 's3.tebi.io';
            document.getElementById('newRegion').value = 'us-east-1';
        }

        function clearUpdateUserForm() {
            document.getElementById('updateUserSelect').value = '';
            document.getElementById('updatePassword').value = '';
            document.getElementById('updateAccessKey').value = '';
            document.getElementById('updateSecretKey').value = '';
            document.getElementById('updateBucket').value = '';
            document.getElementById('updateEndpoint').value = '';
            document.getElementById('updateRegion').value = '';
        }
    </script>
</body>
</html>